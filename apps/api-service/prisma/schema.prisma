// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  EMPLOYER
  ADMIN
  TPO
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum KYCStatus {
  NOT_SUBMITTED
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  RESUBMIT_REQUIRED
}

enum InternshipType {
  FULL_TIME
  PART_TIME
  REMOTE
  HYBRID
  ON_SITE
}

enum InternshipStatus {
  DRAFT
  PUBLISHED
  CLOSED
  CANCELLED
}

enum ApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  INTERVIEW_SCHEDULED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum MilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
  PAID
}

enum EscrowStatus {
  PENDING
  FUNDS_HELD
  RELEASED
  REFUNDED
  DISPUTED
}

enum NotificationType {
  APPLICATION_STATUS
  MILESTONE_UPDATE
  MESSAGE
  KYC_UPDATE
  PAYMENT
  SYSTEM
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  KYC_SUBMIT
  ESCROW_FUND
  MILESTONE_APPROVE
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  passwordHash  String     @map("password_hash")
  role          UserRole
  status        UserStatus @default(PENDING_VERIFICATION)
  emailVerified Boolean    @default(false) @map("email_verified")
  kycStatus     KYCStatus? @map("kyc_status")
  
  refreshToken  String?    @map("refresh_token")
  lastLoginAt   DateTime?  @map("last_login_at")
  
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  studentProfile  StudentProfile?
  employerProfile EmployerProfile?
  applications    Application[]
  internships     Internship[]
  kycDocuments    KYCDocument[]
  sentMessages    Message[]       @relation("SentMessages")
  receivedMessages Message[]      @relation("ReceivedMessages")
  notifications   Notification[]
  auditLogs       AuditLog[]

  @@index([email])
  @@index([role, status])
  @@map("users")
}

model StudentProfile {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  fullName       String   @map("full_name")
  phone          String?
  dateOfBirth    DateTime? @map("date_of_birth")
  collegeName    String   @map("college_name")
  collegeEmail   String?  @map("college_email")
  degree         String
  major          String?
  graduationYear Int      @map("graduation_year")
  cgpa           String?
  skills         String[]
  resume         String?
  portfolio      String?
  githubUrl      String?  @map("github_url")
  linkedinUrl    String?  @map("linkedin_url")
  bio            String?  @db.Text
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("student_profiles")
}

model EmployerProfile {
  id          String    @id @default(uuid())
  userId      String    @unique @map("user_id")
  companyName String    @map("company_name")
  industry    String
  website     String
  description String    @db.Text
  logo        String?
  gstNumber   String?   @map("gst_number")
  cinNumber   String?   @map("cin_number")
  trustScore  Int       @default(0) @map("trust_score")
  kycStatus   KYCStatus @default(NOT_SUBMITTED) @map("kyc_status")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([kycStatus])
  @@map("employer_profiles")
}

model KYCDocument {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  documentType   String    @map("document_type")
  documentNumber String    @map("document_number")
  documentUrl    String    @map("document_url")
  status         KYCStatus @default(PENDING)
  reviewedBy     String?   @map("reviewed_by")
  reviewedAt     DateTime? @map("reviewed_at")
  rejectionReason String?  @map("rejection_reason") @db.Text
  
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("kyc_documents")
}

model Internship {
  id                  String           @id @default(uuid())
  employerId          String           @map("employer_id")
  title               String
  description         String           @db.Text
  type                InternshipType
  status              InternshipStatus @default(DRAFT)
  location            String
  duration            Int              // in months
  stipend             Float
  requiredSkills      String[]         @map("required_skills")
  preferredSkills     String[]         @map("preferred_skills")
  responsibilities    String[]
  benefits            String[]
  applicationDeadline DateTime         @map("application_deadline")
  startDate           DateTime         @map("start_date")
  maxApplicants       Int              @default(50) @map("max_applicants")
  viewCount           Int              @default(0) @map("view_count")
  
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  employer            User             @relation(fields: [employerId], references: [id], onDelete: Cascade)
  applications        Application[]

  @@index([employerId])
  @@index([status])
  @@index([applicationDeadline])
  @@map("internships")
}

model Application {
  id           String            @id @default(uuid())
  internshipId String            @map("internship_id")
  studentId    String            @map("student_id")
  status       ApplicationStatus @default(SUBMITTED)
  coverLetter  String            @map("cover_letter") @db.Text
  resumeUrl    String?           @map("resume_url")
  aiMatchScore Float?            @map("ai_match_score")
  interviewDate DateTime?        @map("interview_date")
  interviewNotes String?         @map("interview_notes") @db.Text
  
  appliedAt    DateTime          @default(now()) @map("applied_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  internship   Internship        @relation(fields: [internshipId], references: [id], onDelete: Cascade)
  student      User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  milestones   Milestone[]

  @@unique([internshipId, studentId])
  @@index([studentId])
  @@index([internshipId, status])
  @@map("applications")
}

model Milestone {
  id            String          @id @default(uuid())
  applicationId String          @map("application_id")
  title         String
  description   String          @db.Text
  amount        Float
  dueDate       DateTime        @map("due_date")
  status        MilestoneStatus @default(NOT_STARTED)
  submittedAt   DateTime?       @map("submitted_at")
  approvedAt    DateTime?       @map("approved_at")
  paidAt        DateTime?       @map("paid_at")
  feedback      String?         @db.Text
  
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  application   Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  escrowTransaction EscrowTransaction?

  @@index([applicationId])
  @@index([status])
  @@map("milestones")
}

model EscrowTransaction {
  id            String       @id @default(uuid())
  milestoneId   String       @unique @map("milestone_id")
  amount        Float
  status        EscrowStatus @default(PENDING)
  transactionId String?      @map("transaction_id")
  paymentGatewayResponse Json? @map("payment_gateway_response")
  initiatedAt   DateTime     @default(now()) @map("initiated_at")
  completedAt   DateTime?    @map("completed_at")
  metadata      Json?

  milestone     Milestone    @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([milestoneId])
  @@map("escrow_transactions")
}

model Message {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  senderId       String    @map("sender_id")
  receiverId     String    @map("receiver_id")
  content        String    @db.Text
  attachments    String[]
  isVerified     Boolean   @default(true) @map("is_verified")
  readAt         DateTime? @map("read_at")
  
  createdAt      DateTime  @default(now()) @map("created_at")

  sender         User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver       User      @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId, receiverId])
  @@map("messages")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  read      Boolean          @default(false)
  metadata  Json?
  
  createdAt DateTime         @default(now()) @map("created_at")

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  action     AuditAction
  resource   String
  resourceId String?     @map("resource_id")
  metadata   Json?
  ipAddress  String      @map("ip_address")
  userAgent  String      @map("user_agent") @db.Text
  
  createdAt  DateTime    @default(now()) @map("created_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model SkillEmbedding {
  id         String   @id @default(uuid())
  skillName  String   @unique @map("skill_name")
  embedding  String?  // JSON string for vector data
  category   String
  
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([category])
  @@map("skill_embeddings")
}
